# -*- makefile -*-
# vim:se ft=make:

include $(srcdir)/kern/$(CONFIG_XARCH)/Makerules.KERNEL.$(CONFIG_XARCH)

# $(1) = fiasco - variable
# $(2) = fiasco.debug - variable
# $(3) = Additional $(OBJ_X), e.g. OBJ_<unittest>
define gen_kernel_rules =
$(2): $(call KERNEL_PREREQUISITES,$(3))
	$$(LINK_MESSAGE)
	$$(VERBOSE)$$(LD) $$(LDFLAGS) $$(LD_EMULATION_FLAG) $$(KERNEL_LDFLAGS) -N \
	  $$(if $$(filter $$(KERNEL),$(1)),-Map=$$(KERNEL).map,) \
	  -T $$< -o $$@ $$(filter-out $$<,$$+)
	$$(call ADD_CONFIGFILE,$$@)

$(1): $(1).stripped $(2)
	$$(LINK_MESSAGE)
	$$(VERBOSE)$$(OBJCOPY) --add-gnu-debuglink=$$(strip $(2)) $$< $$@
	$$(VERBOSE)chmod 755 $$@
	$$(VERBOSE)$$(RM) $$<

$(1).stripped: $(2)
	$$(VERBOSE)$$(STRIP) -o $$@ $$<

.INTERMEDIATE: $(1).stripped
endef

# generate $(KERNEL) rule
$(eval $(call gen_kernel_rules,$(KERNEL),$(KERNEL).debug,$(OBJ_STDWORKLOAD)))

Symbols: $(KERNEL).debug
	$(COMP_MESSAGE)
	$(VERBOSE)$(NM) --numeric-sort --demangle $(KERNEL).debug > $@.new
	$(VERBOSE)mv $@.new $@
	$(VERBOSE)chmod 644 $@
